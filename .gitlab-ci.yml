stages:
  - test
  - build
  - deploy

unit_test:
  stage: test
  tags:
    - docker
  image: python:3.9-slim
  script:
    - echo "Running code quality & syntax checks..."
    - pip install --no-cache-dir -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/
    - pip install flake8 -i https://mirrors.aliyun.com/pypi/simple/
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    - echo "✅ Code syntax is good."

variables:
  VERSION: "1.0.1"
  IMAGE_TAG: $HARBOR_URL/$HARBOR_PROJECT/feishu-minute:$VERSION
  IMAGE_TAG_LATEST: $HARBOR_URL/$HARBOR_PROJECT/feishu-minute:latest
  CONTAINER_NAME: feishu-minute-app
  HOST_DATA_DIR: /root/feishu_minute

# 构建阶段：修复 docker login 参数 + 完善 insecure-registry 配置
build_image:
  stage: build
  tags:
    - docker
  image: docker:latest
  services:
    - name: docker:dind
      # 修复1：正确配置 insecure-registry（剥离前缀 + 确保参数格式正确）
      # 生产环境建议：替换为配置合法 TLS 证书，移除 insecure-registry
      command: ["--insecure-registry=${HARBOR_URL#*//}"]
  # 修复2：提前配置 Docker 全局 insecure-registry（兼容旧版本 Docker）
  before_script:
    - echo "{\"insecure-registries\": [\"${HARBOR_URL#*//}\"]}" > /etc/docker/daemon.json
    - service docker restart || true
  script:
    - echo "Logging in to Harbor..."
    # 修复3：使用正确的 --tlsverify=false 参数（Docker 官方标准）
    # 生产环境建议：移除该参数 + 配置 Harbor CA 证书到 /etc/docker/certs.d/
    - docker login --tlsverify=false -u "$HARBOR_USER" -p "$HARBOR_PASSWORD" $HARBOR_URL
    - echo "Building Docker image..."
    - docker build -t $IMAGE_TAG -t $IMAGE_TAG_LATEST .
    - echo "Pushing Docker image..."
    - docker push $IMAGE_TAG
    - docker push $IMAGE_TAG_LATEST
  only:
    - main

# 部署阶段：同步修复远程服务器的 docker login 参数
deploy_container:
  stage: deploy
  tags:
    - docker
  image: alpine:latest
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apk add --update openssh )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $SERVER_IP >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "Deploying to server $SERVER_IP..."
    - ssh $SERVER_USER@$SERVER_IP "mkdir -p $HOST_DATA_DIR"
    - scp docker-compose.yml $SERVER_USER@$SERVER_IP:$HOST_DATA_DIR/docker-compose.yml
    - |
      ssh $SERVER_USER@$SERVER_IP "
        cd $HOST_DATA_DIR
        mkdir -p downloads user_token logs
        
        # 远程服务器也配置 insecure-registry（兼容）
        echo '{\"insecure-registries\": [\"${HARBOR_URL#*//}\"]}' > /etc/docker/daemon.json
        service docker restart || true
        
        echo 'IMAGE_TAG=$IMAGE_TAG' > .env
        echo 'APP_ID=$APP_ID' >> .env
        echo 'APP_SECRET=$APP_SECRET' >> .env
        echo 'APP_VERIFICATION_TOKEN=$APP_VERIFICATION_TOKEN' >> .env
        
        # 同步修复 docker login 参数
        docker login --tlsverify=false -u '$HARBOR_USER' -p '$HARBOR_PASSWORD' '$HARBOR_URL'
        
        docker compose pull
        docker stop $CONTAINER_NAME || true
        docker rm $CONTAINER_NAME || true
        docker compose up -d
      "
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $DEPLOY_ENV == "test"'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual